<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>个人信息</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="css/mui.min.css">
		<link rel="stylesheet" href="css/person_message.css" />
	</head>

	<body>
		<div id="app" class="list" v-cloak>
			<div class="navTop">
				个人中心
				<img class="back" src="./images/back_top.png" @tap="goBack" />
			</div>
			<template v-for="v in msg">
				<div class="message">
					<input id="inputs" type="file" style="display: none;" @change="changImg" />
					<div class="head" id="head" @tap="changeIcon">
						<img ref="imgUser" id="img-user" :src="v.icon" alt="" />
					</div>
					<span>{{v.nickname}}</span>
				</div>
				<ul class="tab">
					<li>
						<div class="li_left">
							<img src="images/person1.png" alt="" />
							<span>幼儿园</span>
						</div>
						<span>{{v.schoolname}}</span>
					</li>
					<li>
						<div class="li_left">
							<img src="images/person2.png" alt="" />
							<span>班级</span>
						</div>
						<span>{{v.classname}}</span>
					</li>
					<li>
						<div class="li_left">
							<img src="images/person3.png" alt="" />
							<span>绑定手机</span>
						</div>
						<span v-html="v.phone?v.phone.substr(0,3)+'****'+v.phone.substr(7,10):''"></span>
					</li>
					<li id="modify" @click="modify">
						<div class="li_left">
							<img src="images/person4.png" alt="" />
							<span>更改密码</span>
						</div>
						<img style="width: 0.3rem;" src="images/car_right.png" alt="" />
					</li>
				</ul>
			</template>
		</div>
		<script src="js/flexible.js"></script>
		<script src="js/mui.min.js"></script>
		<script src="https://cdn.bootcss.com/jquery/2.2.3/jquery.js"></script>
		<script src="js/vue.js"></script>
		<script src="js/common.js"></script>
		<script src="js/app.js"></script>
		<script>
			var order = new Vue({
				el: "#app",
				data: {
					msg: []
				},
				mounted: function() {
					this.onLoad();
				},
				methods: {
					goBack: function() {
						window.history.go(-1);
					},
					onLoad: function() {
						var that = this;
						var id = setInterval(function() {
							var state = app.getState();
							var uid = state.uid;
							if(uid == undefined) {
								return
							} else {
								clearInterval(id);
								var datas = {
									cmd: "getUserInfo",
									uid: uid
								}
								ajax(datas, that.successMsg);
							}
						}, 400);
					},
					successMsg: function(res) {
						if(res.result == 0) {
							this.msg.push(res.dataobject);
						}
					},
					//通过input上传图片
					changImg: function() {
						var that = this;
						var file = inputs.files[0];
						var formdata = new FormData();
						formdata.append("file", file);
						if(file.type.indexOf('image') == 0) {
							$.ajax({
								url: "http://39.107.108.223/kindergarten/api/addimgs",
								type: "POST",
								data: formdata,
								cache: false,
								contentType: false,
								processData: false,
								dataType: "json",
								success: that.successLoad,
								error: function() {
									mui.toast("上传失败");
								}
							});
						} else {
							mui.toast('您上传的文件不是图片');
						}
					},
					successLoad: function(res) {
						that = this;
						if(res.result == 0) {
							document.getElementById('img-user').src = res.dataobject[0];
							this.msg[0].icon = res.dataobject;
							var id = setInterval(function() {
								var state = app.getState();
								var uid = state.uid;
								if(uid == undefined) {
									return
								} else {
									clearInterval(id);
									var msg = {
										cmd: "editUserMessage",
										uid: uid,
										nickname: "",
										icon: res.dataobject[0]
									}
									ajax(msg, that.successChange);
								}
							}, 400);
						}
					},
					successChange: function(res) {
						if(res.result == 0) {
							mui.toast('修改成功');
						}
					},
					changeIcon: function() {
						//模拟input改变事件
						document.getElementById('inputs').click();
					},
					modify: function() {
						window.location.href = "./modify_pass.html"
					},
				}
			});

			mui.init();
		</script>
	</body>

</html>
<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>课程安排</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
		<link rel="stylesheet" href="css/demo.css" />
		<link rel="stylesheet" href="css/vant.css">
		<link rel="stylesheet" href="css/mui.min.css">
		<link rel="stylesheet" href="css/activity.css" />
		<style>
			.mui-table-view {
				margin: 0 !important;
			}
			
			.mui-table-view:before {
				height: 0;
			}
			
			.mui-table-view-cell:after {
				left: 0 !important;
			}
			
			.mui-table-view-cell {
				padding: 0;
			}
		</style>
	</head>

	<body>
		<div id="app" class="lists" v-cloak>
			<div class="navTop">
				课程安排
				<img class="back" src="./images/back_top.png" @tap="goBack" />
			</div>
			<div id="pullrefresh" class="mui-content mui-scroll-wrapper" style="background: #ffffff;margin-top: 44px;">
				<div class="mui-scroll">
					<ul class="mui-table-view">
						<li class="mui-table-view-cell notice" v-for="(v,k) in list" @tap.stop="open_detail(v.lessonid)">
							<div class="mui-slider-right mui-disabled">
								<a class="mui-btn mui-btn-red" @tap.stop="del(k,v.lessonid,$event)">删除</a>
							</div>
							<div class="mui-slider-handle list">
								<div class="list_left">
									<img src="images/classes_sort.png" alt="" />
								</div>
								<div class="list_right">
									<div class="list_title">
										<h4 v-if="v.lessontype == 1">课程安排</h4>
										<h4 v-if="v.lessontype == 2">家庭作业</h4>
										<span class="date">{{v.time}}</span>
									</div>
									<span class="text">{{v.lessoncontent}}</span>
								</div>
							</div>
						</li>
					</ul>
				</div>
			</div>
			<div v-if="show == 1" class="no">
				<img src="images/no.png" alt="" />
			</div>
		</div>
		<script src="js/flexible.js"></script>
		<script src="js/mui.min.js"></script>
		<script src="js/jquery.js"></script>
		<script src="js/vue.js"></script>
		<script src="js/vant.js"></script>
		<script src="js/common.js"></script>
		<script src="js/app.js"></script>
		<script>
			var classes = new Vue({
				el: "#app",
				data: {
					list: [],
					show: 0
				},
				methods: {
					del: function(index, id, event) {
						var that = this;
						var li = event.currentTarget.parentNode.parentNode;
						//删除信息操作
						this.$dialog.confirm({
							title: '课程',
							message: '确定删除此课程安排吗'
						}).then(() => {
							var state = app.getState();
							var uid = state.uid;
							var datas = {
								cmd: "lessondelete",
								uid: uid,
								lessonid: id
							}
							ajax(datas, function(res) {
								if(res.result == 0) {
									that.list.splice(index, 1);
									setTimeout(function() {
										mui.swipeoutClose(li);
									}, 0);
									if(that.list.length == 0) {
										pulldownRefresh();
									}
								}
							});
						}).catch(() => {
							setTimeout(function() {
								mui.swipeoutClose(li);
							}, 0);
							return;
						});
					},
					goBack: function() {
						window.history.go(-1);
					}
				}
			});

			mui.init({
				pullRefresh: {
					container: '#pullrefresh',
					down: {
						style: 'circle',
						callback: pulldownRefresh
					},
					up: {
						auto: true,
						contentrefresh: '正在加载...',
						callback: pullupRefresh
					}
				}
			});

			var count = 1;
			var num = 0;

			function pullupRefresh() {
				var id = setInterval(function() {
					var state = app.getState();
					var uid = state.uid;
					if(uid == undefined) {
						return
					} else {
						clearInterval(id);
						var datas = {
							cmd: "lessonlist",
							uid: uid,
							nowPage: count,
							pageCount: "6"
						}
						ajax(datas, successLoad);
					}
				}, 400);
			}

			function successLoad(res) {
				if(res.result == 0) {
					if(res.dataList == undefined || res.dataList.length == 0) {
						classes.show = 1;
						document.getElementsByClassName('mui-pull-caption')[1].style.fontSize = '0px';
						document.getElementsByClassName('mui-spinner')[0].style.height = '0px';
						document.getElementsByClassName('list')[0].style.height = '100%';
					} else if(res.dataList.length > 0) {
						classes.show = 0;
						document.getElementsByClassName('mui-pull-caption')[1].style.fontSize = '15px';
						document.getElementsByClassName('mui-spinner')[0].style.height = '24px';
						for(var i = 0; i < res.dataList.length; i++) {
							classes.list.push(res.dataList[i])
						}
					}
					num = res.totalPage;
					mui('#pullrefresh').pullRefresh().endPullupToRefresh((++count > num)); //参数为true代表没有更多数据了。
				}
			}

			/**
			 * 下拉刷新具体业务实现
			 */
			function pulldownRefresh() {
				mui('#pullrefresh').pullRefresh().endPulldownToRefresh();
				mui('#pullrefresh').pullRefresh().enablePullupToRefresh();
				classes.list = [];
				count = 1;
			}

			function open_detail(id) {
				window.location.href = './activity_detail.html?id=' + id;
			}
		</script>
	</body>

</html>
<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="Resource/css/demo.css" />
		<link rel="stylesheet" href="Resource/css/vant.css">
		<link rel="stylesheet" href="Resource/css/coupon.css" />
		<title>我的优惠券</title>
		<script src="Resource/js/flexible.js"></script>
		<script src="Resource/js/vue.min.js"></script>
		<script src="Resource/js/vant.js"></script>
		<script src="Resource/js/jquery.min.js"></script>
		<script src="Resource/js/common.js"></script>
		<script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
		<style>
			.list {
				height: 100%;
				/* background: rgb(251, 251, 251); */
			}

			.warn {
				display: flex;
				flex-direction: column;
				width: 100%;
				flex: 1;
				align-items: center;
				justify-content: center;
			}

			.warn img {
				width: 120px;
				height: 120px;
			}

			.warn span {
				font-size: 12px;
				color: rgb(70, 155, 150);
			}
			
			.map {
				flex:1;
				height: 1.8rem;
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
			}
			
			.map>img {
				width: 18px;
				height: 18px;
			}
			
			.bg {
				width: 100%;
				height: 100%;
				background: rgba(0, 0, 0, .6);
				position: fixed;
				left: 0;
				top: 0;
			}
			
			.wx-tip {
				width: 60px;
				position: absolute;
				top: 10px;
				right: 10px;
			}
			
			.share_text {
				width: 60%;
				position: absolute;
				left: 50%;
				top: 100px;
				margin-left: -30%;
				display: flex;
				flex-direction: column;
				justify-content: center;
				align-items: center;
			}
			
			.share_text p {
				color: #fff;
				font-size: 14px;
			}
		</style>
	</head>

	<body>
		<div id="app" class="list" v-cloak>
			<van-list v-model="loading" :finished="finished" finished-text="没有更多了" @load="onLoad">
				<van-pull-refresh v-model="isLoading" @refresh="onRefresh">
					<div class="list_item" v-for="v in list" @click="goCoupon(v.couponId)">
						<div class="list_left">
							<span class="money" v-if="v.type == 1">￥{{v.amount}}</span>
							<span class="money" v-if="v.type == 2">{{v.amount * 100}}折</span>
							<span class="use">满{{parseInt(v.price)}}可用</span>
						</div>
						<div class="list_right">
							<span class="name">{{v.shopName}}</span>
							<span class="time">{{v.endTime}}到期</span>
							<span class="time">领了{{v.count}}个</span>
						</div>
						<div class="map">
							<span class="nav_guide" style="margin-bottom: 8px;" @click.stop="share(v.couponId,v.shopName,v.amount,v.price)">分享</span>
							<span class="nav_guide" @click.stop="goMap(v.lat,v.lon,v.shopName)">去这里</span>
						</div>
					</div>
				</van-pull-refresh>
			</van-list>
			<div class="warn" v-if="onOff">
				<img src="Resource/images/data.png" alt="">
				<span>您还没有领取优惠券呦~</span>
			</div>
			<div class="bg">
				<img class="wx-tip" src="Resource/images/weixin-tip.png" alt="">
				<div class="share_text">
					<p>请点击右上角</p>
					<p>选择分享</p>
				</div>
			</div>
		</div>

		<script>
			var shopName = ''
			var oldPrice = 0
			var newPrice = 0
			var card = new Vue({
				el: '#app',
				data: {
					isLoading: false,
					list: [],
					loading: false,
					finished: false,
					page: 1,
					totalPage: 10,
					onOff: false,
					show_one: false,
					couponId: ''
				},
				methods: {
					change_one: function(item) {
						this.show_one = false
					},
					cancel_one: function() {
						this.show_one = false
					},
					goMap: function(lat,lon,name) {
						var self = this
						var url = location.href.split('#')[0]
						$.ajax({
							url: publicUrl + '/scan',
							method: "post",
							dataType: "json",
							data: {
								url: url
							},
							success: function(res) {
								if (res.result == '0') {
									var appId = res.appId;
									var timestamp = res.timestamp;
									var nonceStr = res.noncestr;
									var signature = res.signature;
									self.openMap(appId, timestamp, nonceStr, signature, lat, lon, name)
								}
							}
						})
					},
					openMap: function(appId, timestamp, nonceStr, signature, lat, lon, name) {
						wx.config({
							// 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
							debug: false,
							// 必填，公众号的唯一标识
							appId: appId,
							// 必填，生成签名的时间戳
							timestamp: timestamp,
							// 必填，生成签名的随机串
							nonceStr: nonceStr,
							// 必填，签名，见附录1
							signature: signature,
							// 必填，需要使用的JS接口列表，所有JS接口列表见附录2
							jsApiList: ['checkJsApi', 'scanQRCode', 'openLocation']
						});
						wx.error(function(res) {
							//这个地方的好处就是wx.config配置错误，会弹出窗口哪里错误，然后根据微信文档查询即可。
							alert(res.errMsg)
						});
						wx.ready(function() {
							wx.openLocation({
								latitude: lat, // 纬度，浮点数，范围为90 ~ -90
								longitude: lon, // 经度，浮点数，范围为180 ~ -180。
								name: '我的位置', // 位置名
								address: name, // 地址详情说明
								scale: 20, // 地图缩放级别,整形值,范围从1~28。默认为最大
								infoUrl: 'http://www.gongjuji.net' // 在查看位置界面底部显示的超链接,可点击跳转（测试好像不可用）
							})
						});
					},
					onRefresh: function() {
						var self = this
						this.list = [];
						this.page = 1;
						this.totalPage = 10;
						this.onLoad();
						setTimeout(function() {
							self.$toast('刷新成功');
							self.isLoading = false;
						}, 500);
					},
					onLoad: function() {
						var shopId = '';
						if(GetQueryString("shopId")){
							shopId = GetQueryString("shopId");
						}
						//注意在此处的滚动加载必须产生滚动条所以多加载几条数据
						if (this.page <= this.totalPage) {
							var datas = {
								uid: uid,
								shopId: shopId,
								page: this.page
							}
							queryData('/couponList', datas, this.successLoad);
							this.page++;
							// 加载状态结束
							this.loading = false;
						} else {
							this.loading = false;
							this.finished = true;
						}
					},
					successLoad: function(res) {
						if (res.result == 0) {
							this.totalPage = res.totalPage;
							if (res.dataList == undefined || res.dataList.length == 0) {
								this.onOff = true;
							} else if (res.dataList.length > 0) {
								this.onOff = false;
								for (var i = 0; i < res.dataList.length; i++) {
									this.list.push(res.dataList[i]);
								}
							}
							console.log(this.list)
							return this.list;
						}
					},
					use: function(id, amount, price) {
						sessionStorage.setItem('id', id);
						sessionStorage.setItem('amount', amount);
						sessionStorage.setItem('price', price);
						window.history.go(-1);
					},
					share(id,name,olds,news) {
						var self = this
						couponIds = decodeURIComponent(id)
						shopName = name
						oldPrice = olds
						newPrice = news
						//分享给朋友
						var url = location.href.split('#')[0];
						$.ajax({
							url: publicUrl + '/scan',
							method: "post",
							dataType: "json",
							data: {
								url: url
							},
							success: function(res) {
								if (res.result == '0') {
									var appId = res.appId;
									var timestamp = res.timestamp;
									var nonceStr = res.noncestr;
									var signature = res.signature;
									var ids = couponIds;
									var shopNames = shopName;
									var olds = oldPrice;
									var news = newPrice;
									self.shareFriend(appId, timestamp, nonceStr, signature,ids,shopNames,olds,news);
								}
							}
						});
						//分享到朋友圈
						$.ajax({
							url: publicUrl + '/scan',
							method: "post",
							dataType: "json",
							data: {
								url: url
							},
							success: function(res) {
								console.log(res)
								if (res.result == '0') {
									var appId = res.appId;
									var timestamp = res.timestamp;
									var nonceStr = res.noncestr;
									var signature = res.signature;
									shareMenu(appId, timestamp, nonceStr, signature);
								}
							}
						});
						$('.bg').show();
					},
					shareFriend(appId, timestamp, nonceStr, signature,ids,shopNames,olds,news) {
						var self = this
						wx.config({
							// 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
							debug: false,
							// 必填，公众号的唯一标识
							appId: appId,
							// 必填，生成签名的时间戳
							timestamp: timestamp,
							// 必填，生成签名的随机串
							nonceStr: nonceStr,
							// 必填，签名，见附录1
							signature: signature,
							// 必填，需要使用的JS接口列表，所有JS接口列表见附录2
							jsApiList: ['checkJsApi', 'onMenuShareTimeline', 'onMenuShareAppMessage']
						});
						wx.error(function(res) {
							//这个地方的好处就是wx.config配置错误，会弹出窗口哪里错误，然后根据微信文档查询即可。
							alert("扫码出错了1：" + res.errMsg)
						});
						wx.ready(function() {
							wx.onMenuShareAppMessage({
								title: '领了吗', // 分享标题
								desc: '领取优惠券有优惠哦~~', // 分享描述
								link: 'http://gongxiang.thekingbull.com/gzh/shareCoupon.html?couponId=' + ids,
								imgUrl: 'https://gongxiang.thekingbull.com/gzh/Resource/images/logo.png', // 分享图标
								type: 'link', // 分享类型,music、video或link，不填默认为link
								dataUrl: '', // 如果type是music或video，则要提供数据链接，默认为空
								success: function() {
									$('.bg').hide();
									alert('分享成功');
									// 用户确认分享后执行的回调函数
								},
								cancel: function() {
									$('.bg').hide();
									alert('分享失败');
									// 用户取消分享后执行的回调函数
								}
							});
						});
					},
					shareMenu(appId, timestamp, nonceStr, signature) {
						wx.config({
							// 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
							debug: false,
							// 必填，公众号的唯一标识
							appId: appId,
							// 必填，生成签名的时间戳
							timestamp: timestamp,
							// 必填，生成签名的随机串
							nonceStr: nonceStr,
							// 必填，签名，见附录1
							signature: signature,
							// 必填，需要使用的JS接口列表，所有JS接口列表见附录2
							jsApiList: ['checkJsApi', 'onMenuShareTimeline', 'onMenuShareAppMessage']
						});
						wx.error(function(res) {
							//这个地方的好处就是wx.config配置错误，会弹出窗口哪里错误，然后根据微信文档查询即可。
							alert("扫码出错了1：" + res.errMsg)
						});
						wx.ready(function() {
							wx.onMenuShareTimeline({
								title: '领了吗', // 分享标题
								link: 'http://gongxiang.thekingbull.com/gzh/shareCoupon.html?couponId=' + couponIds, 
								imgUrl: 'https://gongxiang.thekingbull.com/gzh/Resource/images/logo.png', // 分享图标
								success: function() {
									$('.bg').hide();
									alert('分享成功');
									// 用户确认分享后执行的回调函数
								},
								cancel: function() {
									$('.bg').hide();
									alert('分享失败');
									// 用户取消分享后执行的回调函数
								}
							});
						});
					},
					goCoupon: function(id) {
						window.location.href = "./couponDetail.html?id=" + id + '&type=1'
					}
				}
			})
			
			$('.bg').hide();
			$('.bg').click(function() {
				hide();
			});
			
			function hide() {
				$('.bg').hide();
			}
		</script>
	</body>

</html>

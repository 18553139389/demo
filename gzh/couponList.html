<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="Resource/css/demo.css" />
		<link rel="stylesheet" href="Resource/css/vant.css">
		<link rel="stylesheet" href="Resource/css/couponList.css" />
		<title>店铺名称</title>
		<script src="Resource/js/flexible.js"></script>
		<script src="Resource/js/vue.min.js"></script>
		<script src="Resource/js/vant.js"></script>
		<script src="Resource/js/jquery.min.js"></script>
		<script src="Resource/js/common.js"></script>
		<script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.11&key=953b0c33eebadeb84681e6e9d2d14031"></script>
		<script type="text/javascript" src="https://webapi.amap.com/demos/js/liteToolbar.js"></script>
		<script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
	</head>
	<body>
		<div id="app" class="container" v-cloak>
			<div class="list">
				<div class="list_item">
					<div class="list_img">
						<img :src="listData.shopIcon" alt="" />
					</div>
					<div class="list_content">
						<h3>{{listData.shopName}}</h3>
						<div class="list_address">
							<img src="Resource/images/nav.png" alt="" />
							<span>{{listData.address}}</span>
						</div>
					</div>
					<div class="guide" @click.stop="goMap" style="cursor:pointer;">
						<div class="voucher">去这里</div>
					</div>
				</div>
			</div>
			<div class="coupon-item">
				<div class="title">本店优惠券：</div>
				<div class="warn" v-if="onOff">
					<img src="Resource/images/data.png" alt="">
					<span>暂没有可领取的优惠券呦~</span>
				</div>
				<van-list v-model="loading" :finished="finished" finished-text="没有更多了" @load="onLoad">
					<van-pull-refresh v-model="isLoading" @refresh="onRefresh">
						<ul class="wrapper">
							<li class="type-list" v-for="(v,k) in list" :key="k" @click="goCoupon(v.couponId)">
								<div class="item1">
									<div class="first" style="font-size: 18px;color: red;" v-if="v.type == 1">￥{{v.amount}}</div>
									<div class="first" style="font-size: 18px;color: red;" v-if="v.type == 2">{{v.amount * 100}}折</div>
									<span v-if="v.type == 1">满{{v.price}}元可用</span>
									<span v-if="v.type == 2">满{{v.price}}元可用</span>
								</div>
								<div class="item1" style="margin-left: 30px;">
									<div class="first" v-if="v.type == 1">满减券</div>
									<div class="first" v-if="v.type == 2">折扣券</div>
									<span>{{v.endTime}}到期</span>
								</div>
								<div class="btn" @click.stop="coupon(v.couponId)">
									<div>领券</div>
								</div>
							</li>
						</ul>
					</van-pull-refresh>
				</van-list>
			</div>
		</div>

		<script>
			var app = new Vue({
				el: "#app",
				data: {
					isLoading: false,
					list: [],
					listData: {},
					loading: false,
					finished: false,
					page: 1,
					totalPage: 10,
					onOff: false
				},
				methods: {
					onRefresh: function() {
						var self = this
						this.list = [];
						this.page = 1;
						this.totalPage = 10;
						this.onLoad();
						setTimeout(function() {
							self.$toast('刷新成功');
							self.isLoading = false;
						}, 500);
					},
					onLoad: function() {
						var id = GetQueryString('id')
						var self = this
						var shops = {
							shopId: id
						}
						queryData('/shopDetail', shops, function(res){
							if(res.result == 0){
								self.listData = res
								document.title = res.shopName
							}
						});
						if (this.page <= this.totalPage) {
							var datas = {
								uid: uid,
								shopId: id,
								page: 1
							}
							queryData('/shopCouponList', datas, this.successLoad);
							// // 加载状态结束
							this.loading = false;
						} else {
							this.loading = false;
							this.finished = true;
						}
					},
					successLoad: function(res) {
						if (res.result == 0) {
							this.totalPage = res.totalPage;
							if (res.dataList == undefined || res.dataList.length == 0) {
								this.onOff = true;
							} else if (res.dataList.length > 0) {
								this.onOff = false;
								for (var i = 0; i < res.dataList.length; i++) {
									this.list.push(res.dataList[i]);
								}
								this.page++;
							}
							return this.list;
						}
					},
					goMap: function() {
						var self = this
						var lat = parseFloat(GetQueryString('lat'))
						var lon = parseFloat(GetQueryString('lon'))
						var url = window.location.href.split('#')[0]
						url = encodeURIComponent(url)
						$.ajax({
							url: publicUrl + '/scan',
							method: "post",
							dataType: "json",
							data: {
								url: url
							},
							success: function(res) {
								if (res.result == 0) {
									var appId = res.appId;
									var timestamp = res.timestamp;
									var nonceStr = res.noncestr;
									var signature = res.signature;
									self.openMap(appId, timestamp, nonceStr, signature, lat, lon, self.listData.address)
								}
							}
						})
					},
					openMap: function(appId, timestamp, nonceStr, signature, lat, lon, name) {
						wx.config({
							// 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
							debug: false,
							// 必填，公众号的唯一标识
							appId: appId,
							// 必填，生成签名的时间戳
							timestamp: timestamp,
							// 必填，生成签名的随机串
							nonceStr: nonceStr,
							// 必填，签名，见附录1
							signature: signature,
							// 必填，需要使用的JS接口列表，所有JS接口列表见附录2
							jsApiList: ['checkJsApi', 'scanQRCode', 'openLocation']
						});
						wx.error(function(res) {
							//这个地方的好处就是wx.config配置错误，会弹出窗口哪里错误，然后根据微信文档查询即可。
							alert(res.errMsg)
						});
						wx.ready(function() {
							wx.openLocation({
								latitude: lat, // 纬度，浮点数，范围为90 ~ -90
								longitude: lon, // 经度，浮点数，范围为180 ~ -180。
								name: '我的位置', // 位置名
								address: name, // 地址详情说明
								scale: 20, // 地图缩放级别,整形值,范围从1~28。默认为最大
								infoUrl: 'http://www.gongjuji.net' // 在查看位置界面底部显示的超链接,可点击跳转（测试好像不可用）
							})
						});
					},
					coupon: function(id) {
						datas = {
							uid: uid,
							couponId: id
						}
						queryData('/addCoupon', datas, this.successCoupon);
					},
					successCoupon: function(res) {
						if (res.result == 0) {
							this.$toast('领取成功');
						} else {
							this.$toast(res.resultNote)
						}
					},
					goCoupon: function(id) {
						window.location.href = "./couponDetail.html?id=" + id
					}
				}
			})
		</script>
	</body>
</html>

<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="Resource/css/demo.css" />
		<link rel="stylesheet" href="Resource/css/vant.css">
		<link rel="stylesheet" href="Resource/css/business_pay.css" />
		<title>立即买单</title>
		<script src="Resource/js/flexible.js"></script>
		<script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
		<script src="Resource/js/vue.min.js"></script>
		<script src="Resource/js/vant.js"></script>
		<script src="Resource/js/jquery.min.js"></script>
		<script src="Resource/js/common.js"></script>
	</head>

	<body>
		<div id="app">
			<div class="list">
				<div class="sure_pay">
					<h3>消费总额：</h3>
					<input type="number" placeholder="询问服务员后输入" v-model="money" :value="money" />
				</div>
			</div>
			<div class="pay_wrapper">
				<div class="money_list" @click="yhj()">
					<span>使用优惠券</span>
					<div class="money_right">
						<span style="color: #FF2828;">{{money1}} ¥</span>
						<img src="Resource/images/icon_right.png" alt="" />
					</div>
				</div>
				<div class="money_list">
					<span>实付金额</span>
					<span style="color: #FF2828;">{{money2}} ¥</span>
				</div>
				<button class="submit" type="button" @click="qr()">和店员已确认，立即买单</button>
				<p>买单仅限于到店支付，请确认金额后提交</p>
			</div>
		</div>

		<script>
			var app = new Vue({
				el: "#app",
				data: {
					money: ''
				},
				mounted: function() {
					this.onLoad();
				},
				computed: {
					money1: function() {
						if (sessionStorage.getItem('amount')) {
							return sessionStorage.getItem('amount');
						} else {
							return 0;
						}
					},
					money2: function() {
						var num = parseFloat(this.money) - parseFloat(this.money1);
						if (isNaN(num)) {
							return 0
						} else if (num <= 0) {
							return 0
						} else {
							return num.toFixed(2)
						}
					}
				},
				methods: {
					onLoad: function() {
						var id = GetQueryString('id');
						if (id != null) {
							var datas = {
								shopId: id
							}
							queryData('/shopDetail', datas, this.success)
						}
						
						if (sessionStorage.getItem('cash')) {
							this.money = sessionStorage.getItem('cash');
						} else {
							return '';
						}
					},
					success: function(res) {
						if (res.result == 0) {
							document.title = res.shopName;
						}
					},
					//跳转到优惠劵页面
					yhj: function() {
						sessionStorage.clear();
						var shopId = GetQueryString('id');
						var cash = this.money;
						sessionStorage.setItem('cash',cash);
						window.location.href = "./coupon.html?shopId=" + shopId;
					},
					//点击付钱
					qr: function() {
						var price = sessionStorage.getItem('price');
						if (parseFloat(this.money) <= parseFloat(price)) {
							this.$toast('优惠券不满足满减条件');
							return
						}

						if (parseFloat(this.money2) <= 0) {
							this.$toast('请重新输入金额');
							return
						}
						var shop = GetQueryString('id');
						var couponId = sessionStorage.getItem('id')
						var datas = {
							uid: uid,
							shopId: shop,
							couponId: couponId,
							price: this.money
						}
						queryData('/addOrder', datas, this.order)
					},
					order: function(res) {
						if (res.result == 0) {
							var body = res.body;
							var appId = body.appId;
							var timeStamp = body.timeStamp;
							var nonceStr = body.nonceStr;
							var packages = body.prepay;
							var signType = body.signType;
							var paySign = body.paySign;
							if (typeof WeixinJSBridge == "undefined") {
								if (document.addEventListener) {
									document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
								} else if (document.attachEvent) {
									document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
									document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
								}
							} else {
								this.onBridgeReady(appId, timeStamp, nonceStr, packages, signType, paySign)
							}
						}
					},
					onBridgeReady: function(appId, timeStamp, nonceStr, package, signType, paySign) {
						WeixinJSBridge.invoke(
							'getBrandWCPayRequest', {
								'appId': appId,
								'timeStamp': timeStamp,
								'nonceStr': nonceStr,
								'package': package,
								'signType': signType,
								'paySign': paySign
							},
							function(res) {
								WeixinJSBridge.log(res.err_msg);
								if (res.err_msg === 'get_brand_wcpay_request:ok') {
									console.log('微信支付成功')
									//  Toast('微信支付成功')
									//  this.$router.push('/MineOrder')
									window.location.href = "./pay_success.html";
								} else if (res.err_msg === 'get_brand_wcpay_request:cancel') {
									console.log('用户取消支付')
									//    Toast('用户取消支付')
									// window.location.href = 'gift_failview.do?out_trade_no=' + this.orderId
								} else if (res.err_msg === 'get_brand_wcpay_request:fail') {
									console.log('网络异常，请重试')
									//    Toast('网络异常，请重试')
								}

							}
						)
					}
				}
			})
		</script>
	</body>
</html>

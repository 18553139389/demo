<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<link rel="stylesheet" href="Resource/css/demo.css">
		<link rel="stylesheet" href="Resource/css/index.css">
		<link rel="stylesheet" href="https://cache.amap.com/lbs/static/main.css" />
		<script src="Resource/js/jquery.min.js"></script>
		<script type="text/javascript" src="https://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
		<title>我要优惠</title>
		<style>
			.warn {
				position: absolute;
				z-index: 99999;
				background: rgba(0,0,0,.6);
				width: 200px;
				height: 30px;
				line-height: 30px;
				top: 50%;
				left: 50%;
				margin-top: -15px;
				margin-left: -100px;
				text-align: center;
				display: none;
				font-size: 13px;
				color: #fff;
			}
		</style>
	</head>
	<body>
		<div id="container"></div>
		<div class="bottom">
			<div class="coupon btns">
				扫码领券
			</div>
			<div class="count btns">
				结算
			</div>
		</div>
		<div class="zero">
			<img src="Resource/images/return.png" alt="">
		</div>
		<div class="nav">
			<div class="nav_left">
				<a id="shop" class="mark" href="./near_shop.html">
					<img src="Resource/images/shop.png" alt="">
				</a>
			</div>
			<div class="nav_right">
				<a id="person" class="mark" href="./person_center.html" style="float: left;margin-left: 5px;">
					<img src="Resource/images/person.png" alt="">
				</a>
			</div>
		</div>
		<div class="warn"></div>
		
		<script src="Resource/js/common.js"></script>
		<script type="text/javascript" src="Resource/js/wxScanInDirect.js"></script>
		<script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.11&key=953b0c33eebadeb84681e6e9d2d14031"></script>
		<script type="text/javascript" src="https://webapi.amap.com/demos/js/liteToolbar.js"></script>
		<script>
			localStorage.removeItem("id");
			localStorage.removeItem("amount");
			localStorage.removeItem("price");
			localStorage.removeItem("types");
			localStorage.removeItem("cash");
			var lat, lon;
			if (sessionStorage.getItem('lat') && sessionStorage.getItem('lon')) {
				var map = new AMap.Map("container", {
					resizeEnable: true,
					zoom: 17, //地图显示的缩放级别
					keyboardEnable: false,
					center: [sessionStorage.getItem('lon'), sessionStorage.getItem('lat')], //中心点坐标,
				});
				var circleMarker = new AMap.CircleMarker({
					center: [sessionStorage.getItem('lon'), sessionStorage.getItem('lat')],
					radius: 12 + Math.random() * 10, //3D视图下，CircleMarker半径不要超过64px
					strokeColor: 'white',
					strokeWeight: 2,
					strokeOpacity: 0.5,
					fillColor: 'rgba(0,0,255,1)',
					fillOpacity: 0.5,
					zIndex: 10,
					bubble: true,
					cursor: 'pointer',
					clickable: true
				});
				circleMarker.setMap(map);
				lat = sessionStorage.getItem('lat');
				lon = sessionStorage.getItem('lon');
				var datas = {
					lon: sessionStorage.getItem('lon'),
					lat: sessionStorage.getItem('lat')
				}
				queryData('/index', datas, locations);
			} else {
				var map = new AMap.Map("container", {
					resizeEnable: true,
					zoom: 17, //地图显示的缩放级别
					keyboardEnable: false
				});
				
				AMap.plugin('AMap.Geolocation', function() {
					geolocation = new AMap.Geolocation({
						enableHighAccuracy: true, //是否使用高精度定位，默认:true
						timeout: 10000, //超过10秒后停止定位，默认：无穷大
						maximumAge: 0, //定位结果缓存0毫秒，默认：0
						convert: true, //自动偏移坐标，偏移后的坐标为高德坐标，默认：true
						showButton: true, //显示定位按钮，默认：true
						buttonPosition: 'LB', //定位按钮停靠位置，默认：'LB'，左下角
						buttonOffset: new AMap.Pixel(10, 20), //定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
						showMarker: true, //定位成功后在定位到的位置显示点标记，默认：true
						showCircle: true, //定位成功后用圆圈表示定位精度范围，默认：true
						panToLocation: true, //定位成功后将定位到的位置作为地图中心点，默认：true
						zoomToAccuracy: true //定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false
					});
					map.addControl(geolocation);
					geolocation.getCurrentPosition(function(status, result) {
						if (status == "complete") {
							lat = result.position.lat;
							lon = result.position.lng;
							sessionStorage.setItem('lat', lat);
							sessionStorage.setItem('lon', lon);
							var datas = {
								lon: lon,
								lat: lat
							}
							queryData('/index', datas, locations)
						} else {
							console.log(status)
						}
					});
					AMap.event.addListener(geolocation, 'complete', onComplete); //返回定位信息
					AMap.event.addListener(geolocation, 'error', onError); //返回定位出错信息
				});
			}

			function locations(res) {
				var marker;
				if (res.result == 0) {
					for (var i = 0; i < res.dataList.length; i++) {
						var jfong = [res.dataList[i].lon, res.dataList[i].lat];
						marker = new AMap.Marker({
							position: new AMap.LngLat(res.dataList[i].lon, res.dataList[i].lat),
							offset: new AMap.Pixel(-10, -10)
						});
						map.add(marker);
					}
				}
			}


			function onComplete(res) {
				console.log(res)
			}

			function onError(res) {
				console.log(res)
			}


			var local = window.sessionStorage;

			// document.getElementById('shop').onclick = function() {
			// 	window.location.href = "./near_shop.html"
			// }

			$(function() {
				var url = self.location.href;
				$('.count').click(function() {
					var url = location.href.split('#')[0];
					$.ajax({
						url: publicUrl + '/scan',
						method: "post",
						dataType: "json",
						data: {
							url: url
						},
						success: function(res) {
							if (res.result == '0') {
								var appId = res.appId;
								var timestamp = res.timestamp;
								var nonceStr = res.noncestr;
								var signature = res.signature;
								directScanQRCode(appId, timestamp, nonceStr, signature);
							}
						}
					})
				})
				
				$('.coupon').click(function() {
					var url = location.href.split('#')[0];
					$.ajax({
						url: publicUrl + '/scan',
						method: "post",
						dataType: "json",
						data: {
							url: url
						},
						success: function(res) {
							if (res.result == '0') {
								var appId = res.appId;
								var timestamp = res.timestamp;
								var nonceStr = res.noncestr;
								var signature = res.signature;
								directScanQRCodeCount(appId, timestamp, nonceStr, signature);
							}
						}
					})
				})
				
				$('.zero').click(function(){
					window.location.reload()
				})
			})
		</script>
	</body>
</html>

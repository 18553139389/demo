<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<link rel="stylesheet" href="Resource/css/demo.css">
		<link rel="stylesheet" href="Resource/css/index.css">
		<link rel="stylesheet" href="https://cache.amap.com/lbs/static/main.css" />
		 <script src="Resource/js/jquery.min.js"></script>  
		 <script type="text/javascript" src="http://res.wx.qq.com/open/js/jweixin-1.2.0.js"></script>
		<title>共享屏幕</title>
	</head>
	<body>
		<div id="container"></div>
		<div class="bottom" >扫码下单</div>
		<div class="nav">
			<div class="nav_left">
				<a id="shop" class="mark" href="javascript:;">
					<img src="Resource/images/shop.png" alt="">
				</a>
			</div>
			<div class="nav_right">
				<a id="person" class="mark" href="./person_center.html" style="float: left;margin-left: 5px;">
					<img src="Resource/images/person.png" alt="">
				</a>
			</div>
		</div>
       
        <script type="text/javascript" src="Resource/js/wxScanInDirect.js"></script>
		<script type="text/javascript" src="https://webapi.amap.com/maps?v=1.4.11&key=953b0c33eebadeb84681e6e9d2d14031"></script>
		<script src="Resource/js/common.js"></script>
		<script type="text/javascript" src="https://webapi.amap.com/demos/js/liteToolbar.js"></script>
		<script>
		var lat,lon;
			mapObj = new AMap.Map('allmap');
			mapObj.plugin('AMap.Geolocation', function() {
				geolocation = new AMap.Geolocation({
					enableHighAccuracy: true, //是否使用高精度定位，默认:true
					timeout: 10000, //超过10秒后停止定位，默认：无穷大
					maximumAge: 0, //定位结果缓存0毫秒，默认：0
					convert: true, //自动偏移坐标，偏移后的坐标为高德坐标，默认：true
					showButton: true, //显示定位按钮，默认：true
					buttonPosition: 'LB', //定位按钮停靠位置，默认：'LB'，左下角
					buttonOffset: new AMap.Pixel(10, 20), //定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
					showMarker: true, //定位成功后在定位到的位置显示点标记，默认：true
					showCircle: true, //定位成功后用圆圈表示定位精度范围，默认：true
					panToLocation: true, //定位成功后将定位到的位置作为地图中心点，默认：true
					zoomToAccuracy: true //定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false
				});
				mapObj.addControl(geolocation);
				geolocation.getCurrentPosition(function(status, result) {
					if(status == "complete") {
						console.log(result)
						console.log(result.addressComponent.district)
						lat = result.position.lat;
						lon = result.position.lng;
                        
					} else {
						alert(status)
						
					}

				});

				AMap.event.addListener(geolocation, 'complete', onComplete); //返回定位信息
				AMap.event.addListener(geolocation, 'error', onError); //返回定位出错信息
			});


            function onComplete(res) {
            	console.log(res)
				// alert(JSON.stringify(res))
			}

			function onError(res) {
				console.log(res)
				// alert(JSON.stringify(res))
			}


		var local=window.sessionStorage;
			var map = new AMap.Map("container", {
				resizeEnable: true,
				zoom: 13, //地图显示的缩放级别
				keyboardEnable: false
			});
			//			AMap.plugin(['AMap.ToolBar', 'AMap.Driving'], function() { //异步同时加载多个插件
			//				var toolbar = new AMap.ToolBar();
			//				map.addControl(toolbar);
			//				var driving = new AMap.Driving(); //驾车路线规划
			//				driving.search( /*参数*/ )
			//			});

			AMap.plugin(['AMap.Autocomplete', 'AMap.PlaceSearch'], function() {
				var autoOptions = {
					city: "郑州", //城市，默认全国
					input: "keyword" //使用联想输入的input的id
				};
				autocomplete = new AMap.Autocomplete(autoOptions);
				var placeSearch = new AMap.PlaceSearch({
					city: '郑州',
					map: map
				})
				AMap.event.addListener(autocomplete, "select", function(e) {
					console.log(e);
					
					//TODO 针对选中的poi实现自己的功能
					placeSearch.setCity(e.poi.adcode);
					placeSearch.search(e.poi.name)
				});
			});
		
   //地图操作工具条插件
		 //    map.plugin(["AMap.ToolBar"], function() {
		 //        map.addControl(new AMap.ToolBar());
		 //    });  
		    
		 //    //比例尺插件
		 //    map.plugin(["AMap.Scale"],function(){
			//     var scale = new AMap.Scale();
			//     map.addControl(scale);  
			// });
		    
		    var geocoder;  
		    map.plugin(["AMap.Geocoder"],function(){  
				geocoder=new AMap.Geocoder({ 
					radius:1000, //以已知坐标为中心点，radius为半径，返回范围内兴趣点和道路信息 
					extensions: "all"//返回地址描述以及附近兴趣点和道路信息，默认"base" 
				}); 
			});   
		    
		 	// //为地图注册click事件获取鼠标点击出的经纬度坐标
		    var clickEventListener = map.on('click', function(e) {
		        lnglatXY=[e.lnglat.getLng(),e.lnglat.getLat()];
		        geocoder.getAddress(lnglatXY, function(status, result) {
		            if (status === 'complete' && result.info === 'OK') {
		                geocoder_CallBack(result,e.lnglat.getLng(),e.lnglat.getLat());
		            }
		        });
		    });	

		 	// 创建点覆盖物
		    var marker = new AMap.Marker();
		    function geocoder_CallBack(data,x,y) {
		    	console.log(data.regeocode.formattedAddress)
		    	console.log(data.regeocode.addressComponent.city);
		    	console.log(x,y)
		    	$('.savebtn').click(function(){
                    //  history.back(-1);
                 //   window.location.href="XXkaichufang.html"
               
                      
		            //	city=data.regeocode.addressComponent.city;
                     //  local.setItem("address",JSON.stringify(e));
					})
		    	

		        // var address = data.regeocode.formattedAddress; //返回地址描述
		        // var prov = data.regeocode.addressComponent.province; //返回地址描述省份
		        // var city = data.regeocode.addressComponent.city; //返回地址描述城市
		        // var town = data.regeocode.addressComponent.district; //返回地址描述区县
		        marker = new AMap.Marker({
			        position: new AMap.LngLat(x, y),
			        ////a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-default.png
			        
			        icon: 'Resource/images/dingwei.png',
			        offset: new AMap.Pixel(-13, -30)
			    });
		        //清空覆盖物
		        map.clearMap();
		        //添加一个覆盖物
		        map.add(marker);
		
		    }
		    document.getElementById('shop').onclick = function() {
				window.location.href = "./near_shop.html?lat=" + lat + '&lng=' + lon;
			}
			$(function(){
                var url = self.location.href;
                console.log(url)
                $('.bottom').click(function(){
                   $.ajax({
                    url:publicUrl+'/scan',
                    method: "post",
                    dataType: "json",
                    data:{
                    	url:'http://gongxiang.thekingbull.com/gzh/index.html'
                    },
                   success:function(res){ 
                   	alert(encodeURIComponent('http://gongxiang.thekingbull.com/gzh/index.html'))
                   	console.log(res)
                   	if(res.result=='0'){
                         var  appId=res.appId;
                           var  timestamp=res.timestamp;
                          var  nonceStr=res.noncestr;
                           var  signature=res.signature;
                           console.log(appId,timestamp,nonceStr,signature)
                           alert(JSON.stringify(res))
                             directScanQRCode(appId,timestamp,nonceStr,signature);
                   	}
  
                   }
                  })
                })
			
			})
		</script>
	</body>
</html>

<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>班级发布</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="css/demo.css" />
		<link rel="stylesheet" href="css/mui.min.css">
		<link rel="stylesheet" href="css/public.css" />
		<style>
			.mui-bar {
				background: #19B8EF;
				box-shadow: 0 0 0 #19B8EF;
				padding-top: 18px;
				height: 62px;
			}
			
			.mui-content>.mui-table-view:first-child {
				margin-top: 0;
			}
			
			.mui-title {
				color: #fff;
			}
			
			.mui-icon-back:before {
				color: #fff;
			}
			
			.mui-fullscreen {
				background: rgba(0, 0, 0, .9);
				position: absolute;
				z-index: 10;
			}
		</style>
	</head>

	<body>
		<div id="app" class="list" v-cloak>
			<div class="navTop">
				班级展示
				<img class="back" src="./images/back_top.png" alt="" @tap="back" />
				<span id="info" class="public" href="javascript:;">确认发布</span>
			</div>
			<textarea id="text" placeholder="请输入您的信息内容..."></textarea>
			<ul id="add_img" class="add_img">
				<li>
					<input id="inputs" type="file" style="display: none;" />
					<img id="head" src="images/add.png" alt="" />
				</li>
				<li class="upload" v-for="(v,k) in lis">
					<img class="mui-action-preview" :src="v.url" alt="" />
					<span class="del">
						<img src="images/del.png" alt="" @tap="del(k,v.url)"/>
					</span>
				</li>
			</ul>
			<!--<div v-if="show == 1" id="loading" class="bg">
				<div class="loading">
					正在上传，请稍候...
				</div>
			</div>-->
		</div>

		<script src="js/flexible.js"></script>
		<script src="js/mui.min.js"></script>
		<script src="js/jquery.js"></script>
		<script src="js/vue.js"></script>
		<script src="js/common.js"></script>
		<script src="js/app.js"></script>
		<script>
			mui.init();
			var editor = new Vue({
				el: "#app",
				data: {
					lis: [],
					imgData: [],
					show: 0
				},
				methods: {
					del: function(item, url) {
						this.lis.splice(item, 1);
						for(var i = 0; i < this.imgData.length; i++) {
							if(this.imgData[i] == url) {
								this.imgData.splice(i, 1);
							}
						}
					},
					back: function() {
						window.history.go(-1);
					}
				}
			});
			//通过input上传图片
			var inputs = document.getElementById('inputs');
			inputs.addEventListener('change', function() {
				var file = inputs.files[0];
				var formdata = new FormData();
				formdata.append("file", file);
				if(file.type.indexOf('image') == 0) {
					$.ajax({
						url: "http://39.107.108.223/kindergarten/api/addimgs",
						type: "POST",
						data: formdata,
						cache: false,
						contentType: false,
						processData: false,
						dataType: "json",
						success: successLoad,
						error: function() {
							mui.toast("上传失败");
						}
					});
				} else {
					mui.toast('您上传的文件不是图片');
				}
			});

			function successLoad(res) {
				if(res.result == 0) {
					var obj = {};
					obj.url = res.dataobject[0];
					editor.imgData.push(res.dataobject[0]);
					editor.lis.push(obj);
				}
			}

			//模拟input改变事件
			var head = document.getElementById('head');
			head.addEventListener('tap', function() {
				inputs.click();
			});

			document.getElementById('info').addEventListener('tap', function(e) {
				var imgArr = editor.imgData;
				var state = app.getState();
				var uid = state.uid;
				var content = document.getElementById('text').value;
				if(content == '') {
					mui.toast('内容不能为空');
					return;
				}
				var id = setInterval(function() {
					var state = app.getState();
					var uid = state.uid;
					if(uid == undefined) {
						return
					} else {
						clearInterval(id);
						var datas = {
							cmd: "teacherclassshowadd",
							uid: uid,
							content: content,
							imagelist: imgArr
						}
						ajax(datas, successPublic);
					}
				}, 100);
			}, false);

			function successPublic(res) {
				if(res.result == 0) {
					mui.toast('班级发布成功');
					document.getElementById('text').value = '';
					editor.imgData = [];
					editor.lis = [];
					window.location.href = './display.html';
				}
			}
		</script>
	</body>

</html>
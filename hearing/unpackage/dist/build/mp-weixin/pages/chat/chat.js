(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/chat/chat"],{"0807":function(t,e,o){"use strict";o.r(e);var s=o("09ad"),n=o.n(s);for(var i in s)"default"!==i&&function(t){o.d(e,t,(function(){return s[t]}))}(i);e["default"]=n.a},"09ad":function(t,e,o){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var s=r(o("66fd")),n=o("2f62"),i=o("3ef4"),a=o("ead1");function r(t){return t&&t.__esModule?t:{default:t}}function c(t,e){var o=Object.keys(t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(t);e&&(s=s.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),o.push.apply(o,s)}return o}function u(t){for(var e=1;e<arguments.length;e++){var o=null!=arguments[e]?arguments[e]:{};e%2?c(Object(o),!0).forEach((function(e){l(t,e,o[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(o)):c(Object(o)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(o,e))}))}return t}function l(t,e,o){return e in t?Object.defineProperty(t,e,{value:o,enumerable:!0,configurable:!0,writable:!0}):t[e]=o,t}var h=wx.createInnerAudioContext(),d=wx.getRecorderManager(),f={duration:6e4,sampleRate:44100,numberOfChannels:1,encodeBitRate:192e3,format:"aac"},g={data:function(){return{Color:"#333",backColor:"#ffffff",messageContent:"",conversation:{},messageKey:"",lastMsgTime:"",count:15,isEmojiOpen:!1,isMoreOpen:!1,isFocus:!1,isGroup:!1,messageList:[],emojiName:i.emojiName,emojiMap:i.emojiMap,emojiUrl:i.emojiUrl,height:0,modalVisible:!1,downloadInfo:{},percent:0,customModalVisible:!1,customData:"",customDescription:"",customExtension:"",focusedInput:"",safeBottom:34,isRecord:!1,isRecording:!1,canSend:!0,startPoint:0,title:"正在录音",rateModal:!1,rate:5,isShow:!1,faceUrl:"https://webim-1252463788.file.myqcloud.com/assets/face-elem/",emojiShow:!0,bigEmojiShow:!1,bigEmoji:["tt01","tt02","tt03","tt04","tt05","tt06","tt07","tt08","tt09","tt10","tt11","tt12","tt13","tt14","tt15","tt16"],revokeModal:!1,revokeMessage:{},currentTime:0,currentTimeID:"",topHeight:0,inputHeight:0}},onShow:function(){this.isShow=!0;var t=this;this.currentTimeID=setInterval((function(){t.currentTime=(new Date).getTime()/1e3}),3e3)},onLoad:function(e){var o=this;console.log(s.default.prototype.CustomBar),this.topHeight=t.getSystemInfoSync().windowHeight-s.default.prototype.CustomBar,this.set=e.toAccount,wx.setNavigationBarTitle({title:this.set}),this.height=this.sysInfo.windowHeight;var n=wx.createSelectorQuery(),i=this;wx.$app.on(this.TIM.EVENT.MESSAGE_RECEIVED,(function(){n.select("#chat").boundingClientRect((function(t){t.bottom-i.height<150&&i.scrollToBottom()})).exec()}));var a=setInterval((function(){0!==o.currentMessageList.length&&(o.scrollToBottom(),clearInterval(a))}),600);this.$bus.$off("atUser"),this.$bus.$on("atUser",(function(t){o.messageContent+=t.userID,o.messageContent+=" "})),d.onStart((function(){console.log("recorder start")})),d.onPause((function(){console.log("recorder pause")})),d.onStop((function(t){if(console.log("recorder stop"),wx.hideLoading(),o.canSend)if(t.duration<1e3)o.$store.commit("showToast",{title:"录音时间太短"});else{var e=wx.$app.createAudioMessage({to:o.$store.getters.toAccount,conversationType:o.$store.getters.currentConversationType,payload:{file:t}});o.$store.commit("sendMessage",e),wx.$app.sendMessage(e)}}))},onReady:function(){var t=this;setTimeout((function(){t.getMessageList()}))},onUnload:function(){clearInterval(this.currentTimeID),wx.$app.setMessageRead({conversationID:this.$store.state.conversation.currentConversationID}),this.isEmojiOpen=!1,this.rateModal=!1,this.isMoreOpen=!1,this.messageContent="",this.isShow=!1;getCurrentPages()},onPullDownRefresh:function(){console.log("onPullDownRefresh"),(0,a.throttle)(this.getMessageList,1e3)()},computed:u({},(0,n.mapState)({currentMessageList:function(t){return t.conversation.currentMessageList},currentConversation:function(t){return t.conversation.currentConversation},myInfo:function(t){return t.user.myInfo},sysInfo:function(t){return t.global.systemInfo}}),{},(0,n.mapGetters)(["isIphoneX"])),methods:{inputFocus:function(t){this.isFocus=!0,this.inputHeight=this.topHeight},onChange:function(t){this.rate=t.mp.detail.index},handleLongPress:function(t){this.startPoint=t.touches[0],"record"===t.target.id&&(this.title="正在录音",this.isRecording=!0,this.startRecording(),this.canSend=!0)},chooseRecord:function(){this.isRecord=!this.isRecord},handleTouchMove:function(t){this.isRecording&&(this.startPoint.clientY-t.touches[t.touches.length-1].clientY>100?(this.title="松开手指，取消发送",this.canSend=!1):this.startPoint.clientY-t.touches[t.touches.length-1].clientY>20?(this.title="上划可取消",this.canSend=!0):(this.title="正在录音",this.canSend=!0))},handleTouchEnd:function(){this.isRecording=!1,wx.hideLoading(),d.stop()},startRecording:function(){var t=this;wx.getSetting({success:function(e){var o=e.authSetting["scope.record"];!1===o?wx.openSetting({success:function(t){var e=t.authSetting["scope.record"];!0===e?wx.showToast({title:"授权成功",icon:"success",duration:1500}):wx.showToast({title:"授权失败",icon:"none",duration:1500})}}):!0===o?(t.isRecording=!0,d.start(f)):wx.authorize({scope:"scope.record",success:function(){wx.showToast({title:"授权成功",icon:"success",duration:1500})}})},fail:function(){wx.showToast({title:"授权失败",icon:"none",duration:1500})}})},scrollToBottom:function(){this.isShow&&wx.pageScrollTo({scrollTop:99999})},customModal:function(){this.customModalVisible=!this.customModalVisible,this.handleClose()},sendCustomMessage:function(){if(0!==this.customData.length||0!==this.customDescription.length||0!==this.customExtension.length){var t=wx.$app.createCustomMessage({to:this.$store.getters.toAccount,conversationType:this.$store.getters.currentConversationType,payload:{data:this.customData,description:this.customDescription,extension:this.customExtension}});this.$store.commit("sendMessage",t),wx.$app.sendMessage(t),this.customModal(),this.customData="",this.customDescription="",this.customExtension=""}else this.$store.commit("showToast",{title:"不能为空"})},loseFocus:function(){this.handleClose()},handleModalShow:function(){var e=this;t.showModal({title:"提示",content:"确定要撤回本消息吗？",success:function(t){t.confirm?(e.download(),console.log("用户点击确定")):t.cancel&&console.log("用户点击取消")}})},handleDownload:function(t){var e=t.fileUrl.slice(t.fileUrl.lastIndexOf(".")).toLowerCase(),o=["doc","docx","xls","xlsx","ppt","pptx","pdf"];o.indexOf(e)>-1?(this.percent=0,this.downloadInfo=t,this.handleModalShow()):this.$store.commit("showToast",{title:"小程序不支持该文件预览哦",icon:"none",duration:2e3})},download:function(){var t=this,e=wx.downloadFile({url:t.downloadInfo.fileUrl,success:function(t){console.log("start downloading: ")},fail:function(e){e.errMsg;t.$store.commit("showToast",{title:"文件下载出错",icon:"none",duration:1500}),t.handleModalShow()},complete:function(o){e=null,wx.openDocument({filePath:o.tempFilePath,success:function(e){console.log("open file fail",e),t.$store.commit("showToast",{title:"打开文档成功",icon:"none",duration:1e3}),t.percent=0,t.handleModalShow()},fail:function(e){console.log("open file fail",e),t.$store.commit("showToast",{title:"小程序不支持该文件预览哦",icon:"none",duration:2e3}),t.handleModalShow()}})}});e.onProgressUpdate((function(e){t.percent=e.progress}))},toDetail:function(t){var e=t.userID;if(e)wx.navigateTo({url:"../user-profile/main?userID=".concat(e)});else{var o=this.currentConversation.conversationID;if(this.isGroup=this.currentConversation.type===this.TIM.TYPES.CONV_GROUP,this.isGroup)wx.navigateTo({url:"../group-profile/main"});else{var s=o.substring(3);wx.navigateTo({url:"../user-profile/main?userID=".concat(s)})}}},getMessageList:function(){console.log("获取历史"),this.$store.dispatch("getMessageList"),wx.stopPullDownRefresh()},handleEmoji:function(){this.isFocus?(this.isFocus=!1,this.isMoreOpen=!1,this.isEmojiOpen=!0):(this.isEmojiOpen=!this.isEmojiOpen,this.isMoreOpen=!1)},handleMore:function(){this.isFocus?(this.isFocus=!1,this.isEmojiOpen=!1,this.isMoreOpen=!0):(this.isMoreOpen=!this.isMoreOpen,this.isEmojiOpen=!1)},handleClose:function(){this.rateModal=!1,this.isFocus=!1,this.isMoreOpen=!1,this.isEmojiOpen=!1},isnull:function(t){if(""===t)return!0;var e="^[ ]+$",o=new RegExp(e);return o.test(t)},sendMessage:function(){var t=this;if(this.isnull(this.messageContent))this.$store.commit("showToast",{title:"消息不能为空"});else{var e=wx.$app.createTextMessage({to:this.$store.getters.toAccount,conversationType:this.$store.getters.currentConversationType,payload:{text:this.messageContent}}),o=this.$store.state.conversation.currentMessageList.length;this.$store.commit("sendMessage",e),wx.$app.sendMessage(e).catch((function(){t.$store.commit("changeMessageStatus",o)})),this.messageContent=""}this.isFocus=!1,this.isEmojiOpen=!1,this.isMoreOpen=!1},sendPhoto:function(t){var e=this;"album"===t?this.chooseImage(t):"camera"===t&&wx.getSetting({success:function(o){o.authSetting["scope.camera"]?e.chooseImage(t):wx.authorize({scope:"scope.camera",success:function(){e.chooseImage(t)}})}})},videoError:function(t){console.log(t),this.$store.commit("showToast",{title:"视频出现错误，错误信息".concat(t.mp.detail.errMsg),duration:1500})},chooseImage:function(t){var e=this,o={};wx.chooseImage({sourceType:[t],count:1,success:function(t){o=wx.$app.createImageMessage({to:e.$store.getters.toAccount,conversationType:e.$store.getters.currentConversationType,payload:{file:t},onProgress:function(t){e.percent=t}}),e.$store.commit("sendMessage",o),wx.$app.sendMessage(o).then((function(){e.percent=0})).catch((function(t){console.log(t)}))}}),this.handleClose()},previewImage:function(t){wx.previewImage({current:t,urls:[t]})},chooseEmoji:function(t){this.messageContent+=t},handleResend:function(t){"fail"===t.status&&wx.$app.resendMessage(t)},sendSurvey:function(){if(this.customExtension){var t=wx.$app.createCustomMessage({to:this.$store.getters.toAccount,conversationType:this.$store.getters.currentConversationType,payload:{data:"survey",description:String(this.rate),extension:this.customExtension}});this.rate=0,this.customExtension="",this.$store.commit("sendMessage",t),wx.$app.sendMessage(t),this.handleClose()}else this.$store.commit("showToast",{title:"建议不要为空哦！"})},openAudio:function(t){var e=this;h.src=t.url,h.play(),h.onPlay((function(){})),h.onEnded((function(){wx.hideToast()})),h.onError((function(){e.$store.commit("showToast",{title:"小程序暂不支持播放该音频格式",icon:"none",duration:2e3})}))},video:function(){var t=this;wx.chooseVideo({sourceType:["album","camera"],maxDuration:60,camera:"back",success:function(e){var o=wx.$app.createVideoMessage({to:t.$store.getters.toAccount,conversationType:t.$store.getters.currentConversationType,payload:{file:e}});t.$store.commit("sendMessage",o),wx.$app.sendMessage(o),t.handleClose()}})},getRandomInt:function(t,e){return t=Math.ceil(t),e=Math.floor(e),Math.floor(Math.random()*(e-t))+t},videoCall:function(){var t={call_id:"",version:3,room_id:this.getRandomInt(0,42949),action:0,duration:0,invited_list:[]},e=JSON.stringify(t),o=wx.$app.createCustomMessage({to:this.$store.getters.toAccount,conversationType:this.$store.getters.currentConversationType,payload:{data:e,description:"",extension:""}});this.$store.commit("sendMessage",o),wx.$app.sendMessage(o);var s="../call/main?args=".concat(e,"&&from=").concat(o.from,"&&to=").concat(o.to);wx.navigateTo({url:s}),this.handleClose()},handleEmojiShow:function(){this.emojiShow=!0,this.bigEmojiShow=!1},handleBigEmojiShow:function(){this.emojiShow=!1,this.bigEmojiShow=!0},chooseBigEmoji:function(t){var e=wx.$app.createFaceMessage({to:this.$store.getters.toAccount,conversationType:this.$store.getters.currentConversationType,payload:{index:1,data:t}});this.$store.commit("sendMessage",e),wx.$app.sendMessage(e),this.handleClose()},handleMessage:function(e){if(e.from===this.myInfo.userID){var o=12e4,s=(new Date).getTime();if(s-1e3*e.time<o){var n=this;t.showModal({title:"提示",content:"确定要撤回本消息吗？",success:function(t){t.confirm?(n.handleRevokeMessage(),console.log("用户点击确定")):t.cancel&&console.log("用户点击取消")}}),this.revokeMessage=e}}},handleRevokeMessage:function(){var t=this;wx.$app.revokeMessage(this.revokeMessage).then((function(e){console.log(e),t.revokeModal=!1,t.$store.commit("showToast",{title:"撤回成功",duration:500})}))},reEdit:function(t){this.messageContent=t.payload.text}},destory:function(){}};e.default=g}).call(this,o("543d")["default"])},"3bf3":function(t,e,o){"use strict";(function(t){o("7954");s(o("66fd"));var e=s(o("b1bf"));function s(t){return t&&t.__esModule?t:{default:t}}t(e.default)}).call(this,o("543d")["createPage"])},6497:function(t,e,o){"use strict";var s=o("9601"),n=o.n(s);n.a},9601:function(t,e,o){},b1bf:function(t,e,o){"use strict";o.r(e);var s=o("ee4d"),n=o("0807");for(var i in n)"default"!==i&&function(t){o.d(e,t,(function(){return n[t]}))}(i);o("6497");var a,r=o("f0c5"),c=Object(r["a"])(n["default"],s["b"],s["c"],!1,null,null,null,!1,s["a"],a);e["default"]=c.exports},ee4d:function(t,e,o){"use strict";var s,n=function(){var t=this,e=t.$createElement,s=(t._self._c,o("92b2")),n=o("b071");t._isMounted||(t.e0=function(e){t.isFocus=!1}),t.$mp.data=Object.assign({},{$root:{m0:s,m1:n}})},i=[];o.d(e,"b",(function(){return n})),o.d(e,"c",(function(){return i})),o.d(e,"a",(function(){return s}))}},[["3bf3","common/runtime","common/vendor"]]]);